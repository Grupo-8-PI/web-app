name: PR - Pull Request Checks

on:
  pull_request:
    branches:
      - main
      - develop
    types:
      - opened
      - synchronize
      - reopened

# Cancela checks anteriores do mesmo PR
concurrency:
  group: pr-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  NODE_VERSION: '18'
  WORKING_DIR: ./AEJLivrosFront

jobs:
  # ============================================
  # Valida√ß√£o do PR
  # ============================================
  validate:
    name: üìã Validate PR
    runs-on: ubuntu-latest
    steps:
      - name: üìã Verificar conven√ß√£o do t√≠tulo
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "üìã T√≠tulo: $PR_TITLE"
          
          PATTERN="^(feat|fix|docs|style|refactor|perf|test|chore|ci|build|revert)(\(.+\))?: .+"
          
          if [[ "$PR_TITLE" =~ $PATTERN ]]; then
            echo "‚úÖ T√≠tulo segue Conventional Commits!"
            echo "## ‚úÖ PR Title Valid" >> $GITHUB_STEP_SUMMARY
            echo "T√≠tulo: \`$PR_TITLE\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è T√≠tulo n√£o segue a conven√ß√£o"
            echo "## ‚ö†Ô∏è PR Title Warning" >> $GITHUB_STEP_SUMMARY
            echo "O t√≠tulo n√£o segue [Conventional Commits](https://www.conventionalcommits.org/)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Formato:** \`tipo(escopo): descri√ß√£o\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Exemplos:**" >> $GITHUB_STEP_SUMMARY
            echo "- \`feat: adicionar login com Google\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`fix(auth): corrigir valida√ß√£o de token\`" >> $GITHUB_STEP_SUMMARY
            echo "- \`docs: atualizar README\`" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # Quality Checks (Lint + Build + Security)
  # ============================================
  quality:
    name: üîç Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v6

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '${{ env.WORKING_DIR }}/package-lock.json'

      - name: üìö Instalar depend√™ncias
        working-directory: ${{ env.WORKING_DIR }}
        run: npm ci --prefer-offline --no-audit

      - name: üîç Lint
        id: lint
        working-directory: ${{ env.WORKING_DIR }}
        run: npm run lint
        continue-on-error: true

      - name: üèóÔ∏è Build
        id: build
        working-directory: ${{ env.WORKING_DIR }}
        run: npm run build
        continue-on-error: true

      - name: üîí Security Audit
        id: security
        working-directory: ${{ env.WORKING_DIR }}
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: üìä Bundle Size
        id: bundle
        if: steps.build.outcome == 'success'
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          TOTAL=$(du -sh dist/ | cut -f1)
          JS_SIZE=$(find dist -name "*.js" -exec du -ch {} + | tail -1 | cut -f1)
          CSS_SIZE=$(find dist -name "*.css" -exec du -ch {} + | tail -1 | cut -f1)
          
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "js=$JS_SIZE" >> $GITHUB_OUTPUT
          echo "css=$CSS_SIZE" >> $GITHUB_OUTPUT

      - name: üìã Resumo
        run: |
          echo "## üîç Quality Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ESLint | ${{ steps.lint.outcome == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ steps.build.outcome == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ steps.security.outcome == 'success' && '‚úÖ Passed' || '‚ö†Ô∏è Warnings' }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.build.outcome }}" == "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üìä Bundle Size" >> $GITHUB_STEP_SUMMARY
            echo "- **Total:** ${{ steps.bundle.outputs.total }}" >> $GITHUB_STEP_SUMMARY
            echo "- **JS:** ${{ steps.bundle.outputs.js }}" >> $GITHUB_STEP_SUMMARY
            echo "- **CSS:** ${{ steps.bundle.outputs.css }}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ‚ùå Falhar se lint ou build falharam
        if: steps.lint.outcome == 'failure' || steps.build.outcome == 'failure'
        run: |
          echo "‚ùå Quality checks falharam!"
          exit 1

  # ============================================
  # Docker Build Test
  # ============================================
  docker:
    name: üê≥ Docker Test
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v6

      - name: üê≥ Setup Buildx
        uses: docker/setup-buildx-action@v3

      - name: üèóÔ∏è Build
        uses: docker/build-push-action@v6
        with:
          context: ${{ env.WORKING_DIR }}
          push: false
          load: true
          tags: test:pr-${{ github.event.pull_request.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: üß™ Test Container
        run: |
          # Passar API_URL para o container (necess√°rio para o entrypoint)
          docker run -d --name test -p 8080:80 -e API_URL=http://localhost:8080 test:pr-${{ github.event.pull_request.number }}
          sleep 5
          
          # Verificar se container est√° rodando
          if ! docker ps | grep -q test; then
            echo "‚ùå Container n√£o iniciou!"
            docker logs test
            exit 1
          fi
          
          if curl -sf http://localhost:8080 > /dev/null; then
            echo "‚úÖ Container funcionando!"
            echo "## üê≥ Docker Test" >> $GITHUB_STEP_SUMMARY
            echo "‚úÖ Container build e teste bem-sucedidos" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Container n√£o respondeu"
            docker logs test
            exit 1
          fi
          
          docker stop test

  # ============================================
  # Coment√°rio no PR
  # ============================================
  comment:
    name: üí¨ PR Comment
    runs-on: ubuntu-latest
    needs: [validate, quality, docker]
    if: always()
    permissions:
      pull-requests: write
    steps:
      - name: üí¨ Comentar
        uses: actions/github-script@v8
        with:
          script: |
            const validate = '${{ needs.validate.result }}';
            const quality = '${{ needs.quality.result }}';
            const docker = '${{ needs.docker.result }}';
            
            const getIcon = (result) => {
              if (result === 'success') return '‚úÖ';
              if (result === 'failure') return '‚ùå';
              return '‚ö†Ô∏è';
            };
            
            const body = `## ü§ñ CI/CD Status Report
            
            | Check | Status |
            |-------|--------|
            | PR Validation | ${getIcon(validate)} ${validate} |
            | Quality (Lint/Build/Security) | ${getIcon(quality)} ${quality} |
            | Docker Build | ${getIcon(docker)} ${docker} |
            
            ---
            
            ${quality === 'success' && docker === 'success' 
              ? '### ‚úÖ Pronto para review!' 
              : '### ‚ö†Ô∏è Corrija os problemas antes do merge'}
            
            <sub>Atualizado em ${new Date().toISOString()}</sub>
            `;
            
            // Buscar coment√°rio existente
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && 
              c.body.includes('ü§ñ CI/CD Status Report')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }
