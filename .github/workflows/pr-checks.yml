name: PR - Pull Request Checks

on:
  pull_request:
    branches:
      - main
      - develop
    types:
      - opened
      - synchronize
      - reopened

env:
  NODE_VERSION: '18'

jobs:
  # Valida√ß√£o do PR
  pr-validation:
    name: üìã PR Validation
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout do c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üìã Verificar t√≠tulo do PR
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "T√≠tulo do PR: $PR_TITLE"
          
          # Verificar se o t√≠tulo segue conven√ß√£o (opcional)
          if [[ ! "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|perf|test|chore|ci|build)(\(.+\))?:.*$ ]]; then
            echo "‚ö†Ô∏è Aviso: O t√≠tulo do PR n√£o segue a conven√ß√£o de commits convencionais."
            echo "Formato sugerido: tipo(escopo): descri√ß√£o"
            echo "Exemplos: feat: nova funcionalidade, fix: corre√ß√£o de bug"
          else
            echo "‚úÖ T√≠tulo do PR segue a conven√ß√£o!"
          fi

  # Lint e Build
  lint-build:
    name: üîç Lint & Build Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./AEJLivrosFront

    steps:
      - name: üì• Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './AEJLivrosFront/package-lock.json'

      - name: üìö Instalar depend√™ncias
        run: npm ci

      - name: üîç Executar ESLint
        run: npm run lint
        continue-on-error: false

      - name: üèóÔ∏è Verificar Build
        run: npm run build

  # An√°lise de seguran√ßa
  security-check:
    name: üîí Security Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./AEJLivrosFront

    steps:
      - name: üì• Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './AEJLivrosFront/package-lock.json'

      - name: üìö Instalar depend√™ncias
        run: npm ci

      - name: üîí Audit de depend√™ncias
        run: npm audit --audit-level=high
        continue-on-error: true

  # Verifica√ß√£o de tamanho do bundle
  bundle-size:
    name: üìä Bundle Size Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./AEJLivrosFront

    steps:
      - name: üì• Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: üì¶ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './AEJLivrosFront/package-lock.json'

      - name: üìö Instalar depend√™ncias
        run: npm ci

      - name: üèóÔ∏è Build da aplica√ß√£o
        run: npm run build

      - name: üìä Analisar tamanho do bundle
        run: |
          echo "üìä An√°lise do tamanho do bundle:"
          echo "================================"
          du -sh dist/
          echo ""
          echo "üìÅ Arquivos principais:"
          find dist -name "*.js" -o -name "*.css" | head -20 | xargs -I {} sh -c 'echo "{}: $(du -h {} | cut -f1)"'

  # Coment√°rio no PR com resultado
  pr-comment:
    name: üí¨ PR Comment
    runs-on: ubuntu-latest
    needs: [pr-validation, lint-build, security-check, bundle-size]
    if: always()
    permissions:
      pull-requests: write

    steps:
      - name: üí¨ Comentar no PR
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('## ü§ñ CI/CD Status Report')
            );
            
            const lintBuild = '${{ needs.lint-build.result }}';
            const security = '${{ needs.security-check.result }}';
            const bundleSize = '${{ needs.bundle-size.result }}';
            
            const getEmoji = (result) => result === 'success' ? '‚úÖ' : result === 'failure' ? '‚ùå' : '‚ö†Ô∏è';
            
            const body = `## ü§ñ CI/CD Status Report
            
            | Check | Status |
            |-------|--------|
            | Lint & Build | ${getEmoji(lintBuild)} ${lintBuild} |
            | Security Check | ${getEmoji(security)} ${security} |
            | Bundle Size | ${getEmoji(bundleSize)} ${bundleSize} |
            
            ---
            *Atualizado em: ${new Date().toISOString()}*
            `;
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
